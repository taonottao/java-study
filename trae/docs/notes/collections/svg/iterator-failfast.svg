<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="880" height="330" viewBox="0 0 880 330" role="img" aria-label="Iterator fail-fast flow">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L10,3 L0,6 Z" fill="#555" />
    </marker>
    <style>
      .box{fill:#f7fafc;stroke:#2b6cb0;stroke-width:1.5;rx:6;ry:6}
      .title{font:600 14px Segoe UI,Arial; fill:#2b6cb0}
      .text{font:12px Segoe UI,Arial; fill:#2d3748}
      .note{font:12px Segoe UI,Arial; fill:#718096}
      .warn{fill:#fed7d7;stroke:#c53030;stroke-width:1.5;rx:6;ry:6}
      .ok{fill:#c6f6d5;stroke:#2f855a;stroke-width:1.5;rx:6;ry:6}
    </style>
  </defs>

  <!-- Collection -->
  <rect x="20" y="30" width="220" height="90" class="box"/>
  <text x="30" y="55" class="title">Collection (ArrayList/HashMap)</text>
  <text x="30" y="80" class="text">字段：modCount</text>
  <text x="30" y="100" class="note">结构性修改时 modCount++</text>

  <!-- Iterator -->
  <rect x="300" y="30" width="240" height="110" class="box"/>
  <text x="310" y="55" class="title">Iterator</text>
  <text x="310" y="80" class="text">expectedModCount = modCount</text>
  <text x="310" y="100" class="text">next() 时校验一致性</text>
  <text x="310" y="120" class="note">remove() 同步 expectedModCount</text>

  <!-- arrows: collection -> iterator() -->
  <line x1="240" y1="75" x2="300" y2="75" stroke="#4a5568" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="245" y="65" class="note">iterator()</text>

  <!-- Safe path box -->
  <rect x="580" y="20" width="270" height="120" class="ok"/>
  <text x="590" y="45" class="title" fill="#276749">安全路径</text>
  <text x="590" y="70" class="text">1) next()</text>
  <text x="590" y="90" class="text">2) Iterator.remove()</text>
  <text x="590" y="110" class="note">集合与迭代器的计数保持一致</text>

  <line x1="540" y1="90" x2="580" y2="80" stroke="#2f855a" stroke-dasharray="4 3" marker-end="url(#arrow)"/>

  <!-- Fail-fast path -->
  <rect x="300" y="180" width="220" height="110" class="box"/>
  <text x="310" y="205" class="title">直接修改集合</text>
  <text x="310" y="230" class="text">list.add/remove/clear ...</text>
  <text x="310" y="250" class="note">→ modCount 改变</text>

  <line x1="410" y1="180" x2="410" y2="140" stroke="#4a5568" stroke-width="1.2" marker-end="url(#arrow)"/>
  <text x="420" y="165" class="note">迭代未结束</text>

  <rect x="580" y="170" width="270" height="130" class="warn"/>
  <text x="590" y="195" class="title" fill="#9b2c2c">fail-fast</text>
  <text x="590" y="220" class="text">下次 next()/remove() 时</text>
  <text x="590" y="240" class="text">expectedModCount ≠ modCount</text>
  <text x="590" y="265" class="text" fill="#9b2c2c">→ ConcurrentModificationException</text>

  <line x1="520" y1="235" x2="580" y2="235" stroke="#c53030" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- Footer note -->
  <text x="20" y="320" class="note">要点：遍历期间如需删除元素，使用 Iterator.remove()；并发修改场景使用并发集合或外部同步。</text>
</svg>